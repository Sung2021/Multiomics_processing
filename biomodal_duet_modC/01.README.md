# Biomodal CXreport to methylKit Pipeline

biomodal duet evoC CXreport 파일을 methylKit 형식으로 변환하여 5mC와 5hmC를 분리 분석하는 파이프라인

## 개요

biomodal duet evoC 파이프라인은 각 샘플당 3개의 CXreport 파일을 생성합니다:
- `*_mC.CXreport.txt.gz`: 5-methylcytosine (5mC) 데이터
- `*_hmC.CXreport.txt.gz`: 5-hydroxymethylcytosine (5hmC) 데이터  
- `*_modC.CXreport.txt.gz`: 5mC + 5hmC + undifferentiated modC (총합)

이 파이프라인은 modC 파일에서 5mC와 5hmC를 분리하여 methylKit으로 분석합니다.

## 필요 패키지
```r
install.packages(c("data.table", "dplyr"))

if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("methylKit")
```

## 입력 파일 형식

### CXreport 파일 구조
Tab-delimited, gzip 압축 파일:

| 컬럼 | 설명 |
|------|------|
| contig | 염색체 이름 |
| coordinate | Genomic position |
| strand | +/- |
| mc | 5mC count |
| hmc | 5hmC count |
| c | Unmethylated C count |
| context | CG/CHG/CHH |
| trinucleotide | 3-base context |
| coverage | Total coverage |

## 사용 방법

### 1. 기본 설정
```r
library(data.table)
library(dplyr)
library(methylKit)

# 작업 디렉토리 설정
setwd("your/working/directory")

# 입력 파일 경로
input_dir <- "path/to/modc/files"
```

### 2. 함수 정의
```r
# cxreport 읽기 함수
read_cxreport <- function(file) {
  fread(file, col.names = c("contig", "coordinate", "strand", 
                            "mc", "hmc", "c", 
                            "context", "trinucleotide", "coverage"))
}

# 5mC용 methylKit 형식 변환
convert_5mc_to_methylkit <- function(cxreport_data, sample_id) {
  cg_data <- cxreport_data %>% filter(context == "CG")
  
  mc_format <- cg_data %>%
    mutate(
      chrBase = paste0(contig, ".", coordinate),
      chr = contig,
      base = coordinate,
      coverage_mc = mc + c,
      freqC = (mc / coverage_mc) * 100,
      freqT = 100 - freqC
    ) %>%
    filter(coverage_mc > 0) %>%
    select(chrBase, chr, base, strand, coverage = coverage_mc, freqC, freqT)
  
  output_file <- paste0(sample_id, "_5mC_methylkit.txt")
  fwrite(mc_format, output_file, sep = "\t", quote = FALSE)
  
  return(output_file)
}

# 5hmC용 methylKit 형식 변환
convert_5hmc_to_methylkit <- function(cxreport_data, sample_id) {
  cg_data <- cxreport_data %>% filter(context == "CG")
  
  hmc_format <- cg_data %>%
    mutate(
      chrBase = paste0(contig, ".", coordinate),
      chr = contig,
      base = coordinate,
      coverage_hmc = hmc + c,
      freqC = (hmc / coverage_hmc) * 100,
      freqT = 100 - freqC
    ) %>%
    filter(coverage_hmc > 0) %>%
    select(chrBase, chr, base, strand, coverage = coverage_hmc, freqC, freqT)
  
  output_file <- paste0(sample_id, "_5hmC_methylkit.txt")
  fwrite(hmc_format, output_file, sep = "\t", quote = FALSE)
  
  return(output_file)
}
```

### 3. 파일 변환 및 methylKit 객체 생성
```r
# modC 파일 목록
modc_files <- list.files(input_dir, pattern = "*modC.CXreport.txt.gz$", full.names = TRUE)

# 샘플 ID 추출
sample_ids <- basename(modc_files) %>% 
  gsub("_modC.CXreport.txt.gz", "", .)

# Treatment 그룹 할당
# 예시: 파일명에 10 = treatment2, 8 = treatment1, 9 = control
treatment_vector <- sapply(sample_ids, function(x) {
  if (grepl("10", x)) return(2)      # treatment2
  else if (grepl("8", x)) return(1)  # treatment1
  else if (grepl("9", x)) return(0)  # control
  else return(NA)
})

# 확인
cat("Sample IDs and treatments:\n")
print(data.frame(sample_id = sample_ids, treatment = treatment_vector))

# 모든 파일 변환
mc_files <- c()
hmc_files <- c()

for (i in seq_along(modc_files)) {
  cat("Processing:", sample_ids[i], "\n")
  
  data <- read_cxreport(modc_files[i])
  
  mc_file <- convert_5mc_to_methylkit(data, sample_ids[i])
  hmc_file <- convert_5hmc_to_methylkit(data, sample_ids[i])
  
  mc_files <- c(mc_files, mc_file)
  hmc_files <- c(hmc_files, hmc_file)
}

# methylKit 객체 생성
# 5mC methylRawList
mc_methylkit <- methRead(
  location = as.list(mc_files),
  sample.id = as.list(sample_ids),
  assembly = "hg38",  # Reference genome (hg38, mm10 등)
  treatment = treatment_vector,
  context = "CpG"
)

# 5hmC methylRawList
hmc_methylkit <- methRead(
  location = as.list(hmc_files),
  sample.id = as.list(sample_ids),
  assembly = "hg38",
  treatment = treatment_vector,
  context = "CpG"
)

# 확인
mc_methylkit
hmc_methylkit
table(treatment_vector)
```

## 출력 파일

각 샘플당 2개의 methylKit 형식 파일 생성:
- `{sample_id}_5mC_methylkit.txt`: 5mC 데이터
- `{sample_id}_5hmC_methylkit.txt`: 5hmC 데이터

### methylKit 파일 형식
```
chrBase          chr    base     strand  coverage  freqC   freqT
chr1.10000       chr1   10000    +       25        60.00   40.00
chr1.10001       chr1   10001    -       30        33.33   66.67
```

## 주요 파라미터

### read_cxreport()
- CG context만 필터링
- Coverage > 0인 site만 포함

### convert_5mc_to_methylkit()
- Coverage 계산: `mc + c` (5mC + unmethylated C)
- freqC: 5mC methylation percentage

### convert_5hmc_to_methylkit()
- Coverage 계산: `hmc + c` (5hmC + unmethylated C)
- freqC: 5hmC percentage

### methRead()
- `assembly`: Reference genome (hg38, mm10, mm39 등)
- `treatment`: 샘플 그룹 (0=control, 1=treatment1, 2=treatment2)
- `context`: "CpG" (기본값)

## Treatment 그룹 설정 예시
```r
# 예시 1: 파일명에서 추출
treatment_vector <- sapply(sample_ids, function(x) {
  if (grepl("control", x)) return(0)
  else if (grepl("treat", x)) return(1)
  else return(NA)
})

# 예시 2: 수동 설정 (10개 샘플: control 3개, treatment1 4개, treatment2 3개)
treatment_vector <- c(0, 0, 0,  # control
                     1, 1, 1, 1,  # treatment1
                     2, 2, 2)     # treatment2

# 예시 3: 메타데이터 파일에서 읽기
metadata <- read.csv("metadata.csv")
treatment_vector <- metadata$treatment[match(sample_ids, metadata$sample_id)]
```

## 다음 단계

methylKit 객체 생성 후 분석 진행:
```r
# QC 및 필터링
getMethylationStats(mc_methylkit[[1]], plot=TRUE)
getCoverageStats(mc_methylkit[[1]], plot=TRUE)

# 샘플 통합 (모든 샘플에 공통적으로 존재하는 CpG만)
mc_united <- unite(mc_methylkit, destrand=FALSE)
hmc_united <- unite(hmc_methylkit, destrand=FALSE)

# 샘플 간 상관관계
getCorrelation(mc_united, plot=TRUE)

# Differential methylation 분석
mc_diff <- calculateDiffMeth(mc_united)
hmc_diff <- calculateDiffMeth(hmc_united)

# 유의한 DM site 추출
mc_diff_sig <- getMethylDiff(mc_diff, difference=25, qvalue=0.01)
hmc_diff_sig <- getMethylDiff(hmc_diff, difference=25, qvalue=0.01)
```

## 문제 해결

### Strand 정보
- biomodal CXreport는 strand 정보 포함
- methylKit는 기본적으로 strand-specific 분석
- Destrand 필요시: `unite(..., destrand=TRUE)`

### Coverage threshold
파일 변환 시 coverage threshold 추가:
```r
min_coverage <- 10

mc_format <- cg_data %>%
  mutate(...) %>%
  filter(coverage_mc >= min_coverage) %>%
  select(...)
```

## 참고 자료

- [methylKit manual](https://bioconductor.org/packages/release/bioc/vignettes/methylKit/inst/doc/methylKit.html)
- [biomodal documentation](https://software-docs.biomodal.com/)
- [evoC data interpretation guide](https://software-docs.biomodal.com/projects/data-interpretation-guide/)
